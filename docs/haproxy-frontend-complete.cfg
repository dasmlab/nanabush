# HAProxy Frontend Configuration for nanabush gRPC Service (TCP Mode)
# Complete configuration with logging, rate limiting, and best practices

frontend grpc-nanabush
    # ==========================================
    # Basic Configuration
    # ==========================================
    bind *:50051
    
    # TCP mode - no L7 processing, pure socket forwarding
    mode tcp
    
    # ==========================================
    # Logging Configuration
    # ==========================================
    
    # Enable TCP log format
    option tcplog
    
    # Use global log configuration
    log global
    
    # Custom log format with detailed TCP information
    # Format: ClientIP:Port [Timestamp] Frontend Backend/Server ConnectTime/ClientTime/TotalTime 
    #         BytesRead TermState ActiveConn/FrontendConn/BackendConn/ServerConn/Retries 
    #         ServerQueue/BackendQueue RequestHeaders ResponseHeaders
    # Custom log format - removed %{+Q}r (query string) as it's not applicable in TCP mode
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs"
    
    # Alternative simpler format (if the above is too verbose):
    # log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"
    
    # Note: 'option log-health-checks' only works in backend, not frontend
    # Health check logging is handled in backend section
    
    # Note: In TCP mode, HAProxy cannot capture payload directly
    # Only HTTP header capture is supported: capture request header <name> len <length>
    # For TCP/gRPC logging, use the log-format above to capture connection details
    # If you need payload inspection, consider using tcp-request content inspect-delay
    
    # ==========================================
    # Rate Limiting & Connection Protection
    # ==========================================
    
    # Single stick-table storing both connection rate AND concurrent connections
    # This avoids naming conflicts in HAProxy 3.0.11 when multiple stick-tables are declared
    # Table: 100k entries, expire after 30s of inactivity
    # Store: connection rate over 10s window AND current connection count
    # Note: HAProxy 3.0.11 doesn't support 'name' argument, so we combine both metrics in one table
    stick-table type ip size 100k expire 30s store conn_rate(10s),conn_cur
    
    # Track source IP in table (sc0 = first stick counter)
    tcp-request connection track-sc0 src
    
    # Reject if more than 50 connections per 10 seconds from same IP
    # Adjust based on your needs (50 conn/10s = 5 conn/sec max)
    tcp-request connection reject if { sc0_conn_rate gt 50 }
    
    # Reject if more than 100 concurrent connections from same IP
    # Adjust based on your expected load per client
    tcp-request connection reject if { sc0_conn_cur gt 100 }
    
    # Optional: Track bytes per IP for bandwidth limiting
    # stick-table type ip size 100k expire 60s store bytes_out_rate(60s)
    # tcp-request content track-sc2 src
    # tcp-request content reject if { sc2_bytes_out_rate gt 10485760 }  # 10MB/s per IP
    
    # ==========================================
    # Timeout Configuration
    # ==========================================
    
    # How long to wait for client data (gRPC connections can be long-lived)
    # 5 minutes should be enough for most gRPC requests
    timeout client 300s
    
    # Time to wait for client FIN after client closes connection
    timeout client-fin 10s
    
    # Note: 'timeout connect' and 'timeout queue' are backend-only settings
    # These should be set in backend or defaults section, not frontend
    # timeout connect 10s  # Set in backend
    # timeout queue 30s    # Set in backend
    
    # ==========================================
    # TCP Options for Performance
    # ==========================================
    
    # Note: 'option tcplog' is already set above, don't duplicate
    # Disable Nagle's algorithm for low latency (gRPC benefits from low latency)
    # Note: This is handled at OS level, but you can tune it in global section
    # tune.options.dontlognull  # Don't log null connections (optional)
    
    # ==========================================
    # Connection Tracking & Statistics
    # ==========================================
    
    # Track connection state for statistics
    # This enables connection counters in stats
    
    # Optional: Add connection ID for tracking
    # This requires HAProxy 2.2+
    # unique-id-format %{+X}o\ %ci:%cp_%fi:%fp_%Ts_%rt:%pid
    
    # ==========================================
    # Security & Access Control
    # ==========================================
    
    # Optional: Whitelist specific IPs/networks
    # tcp-request connection accept if { src -f /etc/haproxy/nanabush-whitelist.lst }
    # tcp-request connection reject
    
    # Optional: Block known bad IPs
    # tcp-request connection reject if { src -f /etc/haproxy/nanabush-blacklist.lst }
    
    # Optional: Require source to be from specific network
    # tcp-request connection accept if { src 10.20.1.0/24 }
    # tcp-request connection reject
    
    # ==========================================
    # Error Handling
    # ==========================================
    
    # Custom error pages (not applicable in TCP mode, but good to know)
    # In TCP mode, errors result in connection closure
    
    # ==========================================
    # Default Backend
    # ==========================================
    
    default_backend nanabush-grpc

# ==========================================
# Backend Configuration
# ==========================================

backend nanabush-grpc
    # TCP mode
    mode tcp
    
    # Enable TCP log format
    option tcplog
    
    # Log health check failures (this works in backend)
    option log-health-checks
    
    # Connection balancing algorithm
    # 'first' - use first available server (good for single server)
    # 'leastconn' - use server with least connections (better for multiple servers)
    balance first
    
    # Enable health checks
    option tcp-check
    
    # TCP health check - connect to port and expect immediate close or connection
    tcp-check connect
    
    # Health check interval (check every 10s, mark down after 3 failures, mark up after 2 successes)
    default-server check inter 10s fall 3 rise 2
    
    # Timeout settings (backend-specific)
    timeout connect 10s      # How long to wait for connection to backend
    timeout server 300s      # How long to wait for server response (match client timeout)
    timeout server-fin 10s   # Wait for server FIN after close
    timeout queue 30s        # Max time in queue
    
    # Retry connections to backend
    retries 3
    
    # Server definition
    # Replace 10.20.2.0 with your MetalLB-assigned IP
    server nanabush-1 10.20.2.0:50051 check
    
    # For multiple servers (if you scale later):
    # server nanabush-1 10.20.2.0:50051 check
    # server nanabush-2 10.20.2.1:50051 check backup
    
    # Note: Do NOT declare stick-table in backend if frontend already has stick-tables
    # Stick-tables are scoped per section, but HAProxy 3.0.11 may auto-name them
    # causing conflicts. If you need backend stick-tables, use different stick counters (sc2, sc3, etc.)

