# HAProxy Frontend Configuration for nanabush gRPC Service (TCP Mode)
# Fixed version - correct syntax for TCP mode

frontend grpc-nanabush
    # ==========================================
    # Basic Configuration
    # ==========================================
    bind *:50051
    
    # TCP mode - no L7 processing, pure socket forwarding
    mode tcp
    
    # ==========================================
    # Logging Configuration
    # ==========================================
    
    # Enable TCP log format
    option tcplog
    
    # Use global log configuration
    log global
    
    # Custom log format with detailed TCP information
    # Format: ClientIP:Port [Timestamp] Frontend Backend/Server ConnectTime/ClientTime/TotalTime 
    #         BytesRead TermState ActiveConn/FrontendConn/BackendConn/ServerConn/Retries 
    #         ServerQueue/BackendQueue RequestPayload ResponsePayload
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs"
    
    # Alternative simpler format (if the above is too verbose):
    # log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"
    
    # Capture first 128 bytes of TCP payload for logging (gRPC magic bytes, frame headers)
    # Note: In TCP mode, we capture payload, not headers (headers are HTTP-only concept)
    # This captures gRPC frame headers without capturing full payload (privacy-friendly)
    # Syntax: capture [request|response] [payload] len <length>
    capture request payload len 128
    capture response payload len 128
    
    # ==========================================
    # Rate Limiting & Connection Protection
    # ==========================================
    
    # Track connection rate per IP (connections per 10 seconds)
    # Table: 100k entries, expire after 30s of inactivity
    # Store: connection rate over 10s window
    # Note: Explicit name to avoid conflicts with backend stick-tables
    stick-table type ip size 100k expire 30s store conn_rate(10s) name grpc_conn_rate
    
    # Track source IP in table
    tcp-request connection track-sc0 src table grpc_conn_rate
    
    # Reject if more than 50 connections per 10 seconds from same IP
    # Adjust based on your needs (50 conn/10s = 5 conn/sec max)
    tcp-request connection reject if { sc0_conn_rate(table grpc_conn_rate) gt 50 }
    
    # Track concurrent connections per IP
    # Table: same as above, but store current connection count
    # Note: Explicit name to avoid conflicts
    stick-table type ip size 100k expire 30s store conn_cur name grpc_conn_cur
    
    # Track source IP in second table
    tcp-request connection track-sc1 src table grpc_conn_cur
    
    # Reject if more than 100 concurrent connections from same IP
    # Adjust based on your expected load per client
    tcp-request connection reject if { sc1_conn_cur(table grpc_conn_cur) gt 100 }
    
    # Optional: Track bytes per IP for bandwidth limiting
    # stick-table type ip size 100k expire 60s store bytes_out_rate(60s) name grpc_bytes_rate
    # tcp-request content track-sc2 src table grpc_bytes_rate
    # tcp-request content reject if { sc2_bytes_out_rate(table grpc_bytes_rate) gt 10485760 }  # 10MB/s per IP
    
    # ==========================================
    # Timeout Configuration (Frontend-only)
    # ==========================================
    
    # How long to wait for client data (gRPC connections can be long-lived)
    # 5 minutes should be enough for most gRPC requests
    timeout client 300s
    
    # Time to wait for client FIN after client closes connection
    timeout client-fin 10s
    
    # Note: 'timeout connect' and 'timeout queue' are backend-only settings
    # These must be set in backend or defaults section, not frontend
    
    # ==========================================
    # Security & Access Control
    # ==========================================
    
    # Optional: Whitelist specific IPs/networks
    # tcp-request connection accept if { src -f /etc/haproxy/nanabush-whitelist.lst }
    # tcp-request connection reject
    
    # Optional: Block known bad IPs
    # tcp-request connection reject if { src -f /etc/haproxy/nanabush-blacklist.lst }
    
    # Optional: Require source to be from specific network
    # tcp-request connection accept if { src 10.20.1.0/24 }
    # tcp-request connection reject
    
    # ==========================================
    # Default Backend
    # ==========================================
    
    default_backend nanabush-grpc

# ==========================================
# Backend Configuration
# ==========================================

backend nanabush-grpc
    # TCP mode
    mode tcp
    
    # Enable TCP log format
    option tcplog
    
    # Log health check failures (this works in backend)
    option log-health-checks
    
    # Connection balancing algorithm
    # 'first' - use first available server (good for single server)
    # 'leastconn' - use server with least connections (better for multiple servers)
    balance first
    
    # Enable health checks
    option tcp-check
    
    # TCP health check - connect to port and expect immediate close or connection
    tcp-check connect
    
    # Health check interval (check every 10s, mark down after 3 failures, mark up after 2 successes)
    default-server check inter 10s fall 3 rise 2
    
    # Timeout settings (backend-specific)
    timeout connect 10s      # How long to wait for connection to backend
    timeout server 300s      # How long to wait for server response (match client timeout)
    timeout server-fin 10s   # Wait for server FIN after close
    timeout queue 30s          # Max time in queue
    
    # Retry connections to backend
    retries 3
    
    # Server definition
    # Replace 10.20.2.0 with your MetalLB-assigned IP
    server nanabush-1 10.20.2.0:50051 check
    
    # For multiple servers (if you scale later):
    # server nanabush-1 10.20.2.0:50051 check
    # server nanabush-2 10.20.2.1:50051 check backup

